if test "${vendor}" = "raspberrypi";
then
setenv dtbaddr 0x1fa00000
setenv loadaddr 0x10008000
setenv dtboaddr 0x12008000
else
setenv dtbaddr 0x5fa00000
setenv loadaddr 0x50008000
setenv dtboaddr 0x52008000
fi;

# EMMC cards have 512k erase block size. Align partitions accordingly to avoid issues with erasing.

setenv partitions "uuid_disk=\${uuid_gpt_disk}"
setenv partitions "${partitions};name=bootloader,start=128K,size=130944K,uuid=\${uuid_gpt_bootloader}"
setenv partitions "${partitions};name=uboot-env,size=512K,uuid=\${uuid_gpt_reserved}"
setenv partitions "${partitions};name=misc,size=512K,uuid=\${uuid_gpt_misc}"
setenv partitions "${partitions};name=boot_a,size=32M,uuid=\${uuid_gpt_boot_a}"
setenv partitions "${partitions};name=dtbo_a,size=8M,uuid=\${uuid_gpt_dtbo_a}"
setenv partitions "${partitions};name=vbmeta_a,size=512K,uuid=\${uuid_gpt_vbmeta_a}"
setenv partitions "${partitions};name=super,size=1200M,uuid=\${uuid_gpt_super}"
setenv partitions "${partitions};name=metadata,size=16M,uuid=\${uuid_gpt_metadata}"
setenv partitions "${partitions};name=userdata,size=-,uuid=\${uuid_gpt_userdata}"

setenv bootargs "
 init=/init rootwait ro androidboot.boottime=223.708 androidboot.selinux=permissive
 androidboot.revision=1.0 androidboot.board_id=0x1234567 androidboot.serialno=${serial#}
 androidboot.slot_suffix=_a firmware_class.path=/vendor/etc/firmware
 androidboot.verifiedbootstate=orange ${debug_bootargs}
"

setenv enter_fastboot '
 usb start ;
 fastboot 0 ;
'

setenv bootcmd_bcb '
 ab_select slot_name mmc \${mmc_bootdev}#misc || run enter_fastboot ;
 bcb load $mmc_bootdev misc ;
 bcb test command = bootonce-bootloader && bcb clear command && bcb store && run enter_fastboot ;
 bcb test command = boot-fastboot && setenv androidrecovery true ;
 bcb test command = boot-recovery && setenv androidrecovery true ;
'

setenv bootcmd_prepare_env '
 setenv bootdevice_path \"__SYSFS_MMC0_PATH__\";
 if test \"${mmc_bootdev}\" = \"1\";
 then
  setenv bootdevice_path \"__SYSFS_MMC1_PATH__\";
 fi;
 setenv bootargs \"\$bootargs androidboot.boot_devices=\${bootdevice_path}\" ;
'

setenv bootcmd_start '
 if test \"${androidrecovery}\" != \"true\";
 then
  setenv bootargs \"\$bootargs androidboot.force_normal_boot=1\" ;
 fi;
 abootimg addr \$loadaddr
 abootimg get recovery_dtbo dtbo_addr
 adtimg addr \${dtbo_addr}
 adtimg get dt --index=0 dtb_start dtb_size &&
 cp.b \$dtb_start \$dtbaddr \$dtb_size &&
 fdt addr \$dtbaddr &&
 adtimg get dt --index=1 dtb_start dtb_size &&
 cp.b \$dtb_start \$dtboaddr \$dtb_size &&
 fdt resize 8192 &&
 fdt apply \$dtboaddr &&
 setenv bootargs \"\$bootargs androidboot.dtbo_idx=0,1\" ;
 bootm \$loadaddr
'

setenv bootcmd_block '
 run bootcmd_bcb &&
 part start mmc \$mmc_bootdev boot_a boot_start &&
 part size mmc \$mmc_bootdev boot_a boot_size &&
 mmc dev \$mmc_bootdev &&
 mmc read \$loadaddr \$boot_start \$boot_size
'

setenv bootcmd '
 run bootcmd_prepare_env ;
 run bootcmd_block ;
 run bootcmd_start ;
'

run bootcmd
